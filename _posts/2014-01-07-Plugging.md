---
layout: deafult
title: Plugging
---

When working with node applications I've often needed a plugin architecture, whether it be
with personal projects, the [Adapt framework](https://community.adaptlearning.org) or more recently
[jsbin](http://jsbin.com). One thing that has been tricky is actually working out how to
implement plugins. 

new para

When integrating the Stripe payment service into jsbin, we had to ensure that when it was running on
a local machine, or a enviroment that didn't support stripe that jsbin would continue to work. Our
github auth module is used the same way..

First we require it and pass some options

{% highlight javascript %}
    
    var nodemailer = require('nodemailer'),
        express    = require('express'),
        //... more require statements
        url        = require('url'),
        github     = require('./github')(options), // if used, contains github.id
        flattened;

    //...
{% endhighlight %}

Then we initialize it

{% highlight javascript %}
    
    //...
    
    if (options.github && options.github.id) {
      github.initialize(app);
    }
    app.use(express.urlencoded());
    app.use(express.json());

    //...

{% endhighlight %}

Within the github module we can see the same logic as above wrapped around the
initialize method.

{% highlight javascript %}

    module.exports = function (options) {
      /**
       * Passport configuration
       */

      passport.serializeUser(function(user, done) {
        done(null, user);
      });

      passport.deserializeUser(function(obj, done) {
        done(null, obj);
      });


      if (options.github && options.github.id) {
        setup(options);
        return {
          initialize: function (app) {
            app.use(passport.initialize());
          }
        };
      } else {
        return {
          initialize: function () {
            console.log('doing nothing');
          }
        };
      }
    }

{% endhighlight %}

After using the same technique with the stripe module, I realised that our app.js is going 
to become bloated if plugins keep getting added, so I set to work on a plugin architecture 
that is scalable and allows plugins to be removed or switched out with little to no code
change.

To install to your project just run:
{% highlight bash %}
    npm install -S plugging
{% endhighlight %}

Plugins can take two forms, either as an object with a predefined 'init' method or as a function.
Here's the same plugin written in both forms.

## Plugin as a function

{% highlight javascript %}
    /**
     *  /Users/allouis/dev/project/plugins/myPlugin/index.js
     */
    
    var APIRouteHandler = require('./lib/handlers/api'),
        APIAuth         = require('./lib/handlers/auth'),
        APIParamParser  = require('./lib/params/api');

    module.exports = function(options) {
        var app = options.app,
            APISecurityEnabled = options.API;

        if (APISecurityEnabled) { // Plugins should take care of their own loading logic;
            app.param('apiKey', APIParamParser);
            app.get(/api/:apiKey, APIRouteHandler); 
        }

    }

{% endhighlight %}

## Plugin as an object

{% highlight javascript %}
    /**
     *  /Users/allouis/dev/project/plugins/myPlugin.js
     *  You can define your plugins as both files and folder
     */

    var APIRouteHandler = require('./lib/handlers/api'),
        APIAuth         = require('./lib/handlers/auth'),
        APIParamParser  = require('./lib/params/api'),
        APISecurityEnabled;

    exports.init = function(options) {

        var app = options.app;
        APISecurityEnabled = options.API;

        if (APISecurityEnabled) { // Plugins should take care of their own loading logic;
            app.param('apiKey', APIParamParser);
            app.get(/api/:apiKey, APIRouteHandler); 
        }

    }

    exports.checkAPIKey = function(key) {
        if (!APISecurityEnabled) {
            return false;
        }
        return APIParamParser(key);
    }
    
{% endhighlight %}

Plugins as functions are my most common use case. Plugins that export an object for use as a public API
aren't plugins in the sense that they can be removed from a project and it'll continue to work. 
However, I've added support for them as I can see them being used in applications.

Plugins are loaded via the inital call to the Plugging library, and can either be executed
immediately or later in the app. If your plugins need to be started at different times, you 
can have multiple calls to Plugging and store both references to start them up at seperate times.

## Deffered plugin loading

{% highlight javascript %}
    var http        = require('http'),
        express     = require('express'),
        options     = require('./config'),
        plugging    = require('plugging')(__dirname + '/plugins');
        // Pass in the path to your plugins directory
    
    var app = express();

    app.configure(function(){
        //...
    })

    var server = http.createServer(app);

    server.listen(app.get('port'));

    pluggings.start({
        app: app,
        API: options.API
    }) // this initializes the plugins passing all parameters to the plugin

{% endhighlight %}

## Immediate plugin loading

{% highlight javascript %}
    var http        = require('http'),
        express     = require('express'),
        options     = require('./config');
    
    var app = express();

    app.configure(function(){
        //...
    })

    var server = http.createServer(app);

    server.listen(app.get('port'));

    var pluginOptions = {
        app: app,
        API: app.get('port') === options.APIPort ? true : false
    }

    // If pluggings is passed more than one argument it initialises 
    // plugins immediately passing all extra parameters to plugins
    require('pluggings')(__dirname + '/plugins', pluginOptions);

{% endhighlight %}

## Configuration

You can configure how Plugging works on a basic level. At the moment there are two config options but 
I'm open to adding more as and when requested.

{% highlight javascript %}
    {
        "node_modules": false,
        "init":"init"
    }

{% endhighlight %}

These are the default configs, setting `"node_modules": true` will tell Plugging to scan the top 
level of your node_modules, look for anything with a `"plugging: true"` in the package.json
and use that as a plugin. The `init` key is the name of the method that gets called on object 
style plugins when they're started.

